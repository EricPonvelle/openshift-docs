:_mod-docs-content-type: ASSEMBLY
[id=â€œcloud-experts-gitops-with-argocd]
= Tutorial: Demonstrate GitOps on Managed OpenShift with Argo CD
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: cloud-experts-gitops-with-argocd

toc::[]

//Mobb content metadata
//Brought into ROSA product docs 2023-10-31
// ---
// date: '2021-06-17'
// title: Demonstrate GitOps on Managed OpenShift with ArgoCD
// aliases: ['/experts/demos/gitops/']
// tags: ["GitOps", "ROSA", "ARO"]
// authors:
//   - Steve Mirman
//   - Connor Wooley
// ---

This tutorial helps you run OpenShift GitOps running in your cluster, deploy a sample application, and demonstrates how Argo CD ensures environment consistency.

[NOTE]
====
If you prefer visual guide, you can watch a quick start video on link:https://www.youtube.com/watch?v=Gi18iemF1yI[YouTube].
====

== Prerequisites

* You have a Managed OpenShift Cluster with cluster-admin rights.
* You have the following tools installed:
** link:https://git-scm.com/download/[Git]
** link:https://docs.openshift.com/container-platform/4.13/cli_reference/openshift_cli/getting-started-cli.html#cli-installing-cli_cli-developer-commands[OpenShift command-line interface (CLI) `oc`]
** link:https://argoproj.github.io/argo-cd/cli_installation/[Argo CD CLI]
** link:https://kubectl.docs.kubernetes.io/installation/kustomize/[kam CLI]

== Setting up your environment

. Install the OpenShift GitOps Operator from the *Operator Hub*:
+
image::gitops_operator.png[screenshot of GitOps install]

. Clone the `gitops-demo` GitHub repository to your local machine by running the following command:
+
[source,terminal]
----
$ git clone https://github.com/rh-mobb/gitops-demo gitops
----

. Export your local path to the GitHub files:
+
[source,terminal]
----
$ export GITOPS_HOME="$(pwd)/gitops"
$ cd $GITOPS_HOME
----

. Log in to OpenShift by copying the login command from the OpenShift console:
+
image::oc_login.png[screenshot of login]

. Enter the command in your terminal to authenticate with the OpenShift CLI (`oc`).
+
.Sample output
+
[source,terminal]
----
Logged into "https://<YOUR-INSTANCE>.openshiftapps.com:6443" as "<YOUR-ID>" using the token provided.
----

== Deploying an Argo CD project

. Create a new OpenShift project called *gitops* by running the following command:
+
[source,terminal]
----
$ oc new-project gitops
----

. Add *cluster-admin* rights to the `openshift-gitops-argocd-application-controller` service account in the *openshift-gitops* namespace by using the following command:
+
[source,terminal]
----
$ oc adm policy add-cluster-role-to-user cluster-admin -z openshift-gitops-argocd-application-controller -n openshift-gitops
----

. Retrieve the Argo CD URL to log in to your Argo CD:
+
[source,terminal]
----
$ argoURL=$(oc get route openshift-gitops-server -n openshift-gitops -o jsonpath='{.spec.host}{"\n"}')
$ echo $argoURL
----

. Retrieve the Argo CD password:
+
[source,terminal]
----
$ argoPass=$(oc get secret/openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d)
$ echo $argoPass
----

. In a web browser, navigate to the Argo CD console using the `$argoURL` value:
+
image::argo1.png[screenshot of argocd1]

. Log in with the username `admin` and the password returned as `$argoPass`:
+
image::argo2.png[screenshot of argocd2]

. Optional: if you want to use the Argo CD CLI, run the following command:
+
[source,terminal]
----
$ argocd login --insecure --grpc-web $argoURL  --username admin --password $argoPass
----

. Use the `kubectl` CLI tool to apply the `bgd-app.yaml` file
+
[source,terminal]
----
$ kubectl apply -f documentation/modules/ROOT/examples/bgd-app/bgd-app.yaml
----
+
The `bgd-app.yaml` file defines several things, including the repository's location for the `gitops-bgd-app` application:
+
image::bgd-app-yaml.png[screenshot of bgd-app-yaml]

. Check the rollout by running the following command:
+
[source,terminal]
----
$ kubectl rollout status deploy/bgd -n bgd
----

. Once the rollout is complete, obtain the route to the application by running the following command:
+
[source,terminal]
----
$ oc get route bgd -n bgd -o jsonpath='{.spec.host}{"\n"}'
----

. In your browser, paste the route to open the application:
+
image::app_blue.png[screenshot of app_blue]

. Go back to your Argo CD window and verify that the configuration shows:
+
image::argo_app1.png[screenshot of argo_app1]

. Explore the application in Argo CD. All the components are green, which denotes that these components are synchronized:
+
image::argo_sync.png[screenshot of argo_sync]

== Deploying a change to the application

. In the terminal, enter the following command, which introduces a change into the bgd application:
+
[source,terminal]
----
$ kubectl -n bgd patch deploy/bgd --type='json' -p='[{"op": "replace", "path": "/spec/template/spec/containers/0/env/0/value", "value":"green"}]'
----

. In your Argo CD window, the application should no longer be synchronized:
+
image::argo_out_of_sync.png[screenshot of argo_sync]

. Refresh the bgd application window and note the change in box color:
+
image::bgd_green.png[screenshot of bgd_green]
+
The new deployment changed the box from blue to green. However, the change is only in the OpenShift repository and not in the source code repository.

== Synchronizing an application
. In the Argo CD console, click the `SYNC` button to re-synchronize the bgd application with the approved configuration in the source code repository:
+
image::sync_bgd.png[screenshot of sync_bgd]

. Refresh the bgd application window and note the box color change:
+
image::app_blue.png[screenshot of app_blue]