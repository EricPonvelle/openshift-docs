// Module included in the following assemblies:
//
// * backup_and_restore/application_backup_and_restore/oadp-data-protection-test.adoc

:_mod-docs-content-type: PROCEDURE
[id="oadp-dpt-use-case-azure_{context}"]
= Running a data protection test on an Azure object storage

[role="_abstract"]
If you are using {oadp-short} on an Azure object storage, you need to specify the Azure `STORAGE_ACCOUNT_ID` as part of the secret object. Use the following procedure to run a `DataProtectionTest` (DPT) custom resource (CR) on an Azure cluster.


.Prerequisites

* You have logged in to the Azure cluster as a user with the `cluster-admin` role.
* You have installed the OpenShift CLI (`oc`).
* You have installed the {oadp-short} Operator.
* You have configured a bucket to store the backups.
* You have an application with persistent volume claims (PVCs) running in a separate namespace.


.Procedure

. Add the `Storage Blob Data Contributor` role to Azure `storageAccount` object to avoid DPT run failure. Run the following command:
+
[source,terminal]
----
$ az role assignment create \
--assignee "$AZURE_CLIENT_ID" \
--role "Storage Blob Data Contributor" \
--scope "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$AZURE_STORAGE_ACCOUNT_ID"
----

. In your terminal, export the Azure parameters and create a secret credentials file with the parameters as shown in the following example.
+
To run the DPT CR on Azure, you need to specify the `STORAGE_ACCOUNT_ID` parameter in the secret credentials file.
+
[source,terminal]
----
AZURE_SUBSCRIPTION_ID=<subscription-id>
AZURE_TENANT_ID=<tenant-id>
AZURE_CLIENT_ID=<client-id>
AZURE_CLIENT_SECRET=<client-secret>
AZURE_RESOURCE_GROUP=<resource-group>
AZURE_STORAGE_ACCOUNT_ID=<storage-account>
----

. Create the `Secret` CR as shown in the following example:
+
[source,terminal]
----
$ oc create secret generic cloud-credentials-azure -n openshift-adp --from-file cloud=<credentials_file_path>
----

. Create the `DataProtectionApplication` (DPA) CR by using the configuration shown in the following example:
+
[source,yaml]
----
apiVersion: oadp.openshift.io/v1alpha1
kind: DataProtectionApplication
metadata:
  name: ts-dpa
  namespace: openshift-adp 
spec:
  configuration:
    velero:
      defaultPlugins:
        - azure
        - openshift 
  backupLocations:
    - velero:
        config:
          resourceGroup: oadp-....-b7q4-rg
          storageAccount: oadp...kb7q4
          subscriptionId: 53b8f5...fd54c8a
        credential:
          key: cloud
          name: cloud-credentials-azure # <1>
        provider: azure
        default: true
        objectStorage:
          bucket: <bucket_name>
          prefix: velero
----
<1> Specify the name of the `Secret` object. In this example, the name is `cloud-credentials-azure`.

. Create the DPT CR by specifying the name of backup storage location (BSL), `VolumeSnapshotClass` object, and the persistent volume claim details as shown in the following example:
+
[source,yaml]
----
apiVersion: oadp.openshift.io/v1alpha1
kind: DataProtectionTest
metadata:
  name: dpt-sample
  namespace: openshift-adp
spec:
  backupLocationName: <bsl_name> # <1>
  uploadSpeedTestConfig:
    fileSize: 40MB
    timeout: 120s
  csiVolumeSnapshotTestConfigs:
    - snapshotClassName: csi-azuredisk-vsc # <2>
      timeout: 90s
      volumeSnapshotSource:
        persistentVolumeClaimName: mysql-data # <3>
        persistentVolumeClaimNamespace: ocp-mysql # <4>
    - snapshotClassName: csi-azuredisk-vsc
      timeout: 120s
      volumeSnapshotSource:
        persistentVolumeClaimName: mysql-data1
        persistentVolumeClaimNamespace: ocp-mysql
----
<1> Specify the name of the BSL.
<2> The Azure snapshot class name.
<3> The name of the persistent volume claim.
<4> The name of the persistent volume claim namespace.

. Run the DPT CR to verify the snapshot readiness.
